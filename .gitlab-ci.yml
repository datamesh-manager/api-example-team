image: ubuntu:latest

push-to-dmm:
  stage: deploy
  script:
    - |
      apt-get update && apt-get install -y ca-certificates && apt-get install -y wget && apt-get install -y curl
      
      update-ca-certificates 
      wget -q https://github.com/mikefarah/yq/releases/download/v4.34.1/yq_linux_amd64.tar.gz -O - |\
        tar xz && mv yq_linux_amd64 /usr/bin/yq

      # teams
      files="./teams/*.yml"
      for f in $files
      do
        id=$(yq .id $f)
        json=$(yq -o json $f)
        curl -X 'PUT' \
          "https://app.datamesh-manager.com/api/teams/$id" \
          -H "accept: */*" \
          -H "x-api-key: $GITOPS_EXAMPLE_API_KEY" \
          -H "Content-Type: application/json" \
          -d "$json" \
          -f
      done

      # operational systems
      files="./operationalsystems/*.yml"
      for f in $files
      do
        id=$(yq .id $f)
        json=$(yq -o json $f)
        curl -X 'PUT' \
          "https://app.datamesh-manager.com/api/operationalsystems/$id" \
          -H "accept: */*" \
          -H "x-api-key: $GITOPS_EXAMPLE_API_KEY" \
          -H "Content-Type: application/json" \
          -d "$json" \
          -f
      done

      # data products
      files="./dataproducts/*.yml"
      for f in $files
      do
        id=$(yq .info.id $f)
        json=$(yq -o json $f)
        curl -X 'PUT' \
          "https://app.datamesh-manager.com/api/dataproducts/$id" \
          -H "accept: */*" \
          -H "x-api-key: $GITOPS_EXAMPLE_API_KEY" \
          -H "Content-Type: application/json" \
          -d "$json" \
          -f
      done
